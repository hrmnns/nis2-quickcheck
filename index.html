<!doctype html>
<html lang="de">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NIS‑2 Betroffenheitsprüfung — Demo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="description" content="Interaktive NIS-2 Betroffenheitsprüfung (Proof of Concept)" />
  <style>
    /* Kleine Ergänzungen über Tailwind hinaus */
    .card {
      @apply bg-white shadow-md rounded-2xl p-6;
    }

    .muted {
      @apply text-sm text-gray-500;
    }

    .focus-ring {
      @apply focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-indigo-500;
    }

    .step-item {
      @apply flex items-center gap-2 text-sm;
    }

    .step-badge {
      @apply h-7 w-7 flex items-center justify-center rounded-full border font-semibold;
    }
  </style>
</head>

<body class="bg-slate-50 text-slate-800 min-h-screen flex items-center justify-center p-6">
  <div class="max-w-4xl w-full">
    <header class="mb-6">
      <div class="flex items-center gap-4">
        <img src="https://www.cherware.de/wp-content/uploads/2025/09/cropped-iconme03.png" alt="NIS-2 Icon"
          class="w-16 h-16 mb-4 rounded-full shadow-lg ml-0">
        <div>
          <h1 class="text-2xl font-semibold">NIS‑2 Betroffenheitsprüfung</h1>
          <p class="muted">Schnellcheck: Bestimmen Sie, ob Ihr Unternehmen direkt oder indirekt von NIS‑2 betroffen ist.
          </p>
          <p class="text-gray-400"><a href="https://www.cherware.de/reflect-it/831/">Version v1.1.0 created by cherware.de, 2025</a>
          </p>
        </div>
      </div>
    </header>

    <main class="card">
      <div id="app">
        <div id="intro" class="space-y-4">
          <p>Diese Demo führt dich durch einen vereinfachten Entscheidungsbaum basierend auf den typischen Fragen zur
            NIS‑2‑Relevanz (Sektor, Funktion, Rolle als Dienstleister, Größe, Lieferkettenbezug).</p>
          <div class="flex gap-3">
            <button id="startBtn"
              class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 focus-ring">Prüfung
              starten</button>
            <button id="loadExample"
              class="px-4 py-2 border border-indigo-600 text-indigo-600 rounded-lg hover:bg-indigo-50 focus-ring">Beispiel
              laden</button>
            <button id="downloadReport"
              class="px-4 py-2 bg-slate-100 text-slate-700 rounded-lg hidden focus-ring">Report
              herunterladen</button>
          </div>
        </div>

        <form id="quizForm" class="hidden mt-4 space-y-6">
          <!-- Ebene 1 -->
          <section id="q_sector" class="space-y-2" tabindex="-1">
            <label class="font-medium">1) In welchem Sektor ist Ihr Unternehmen tätig?</label>
            <select id="sector" class="w-full rounded-md border-gray-200 shadow-sm p-2 focus-ring">
              <option value="">-- Bitte wählen --</option>
              <option value="energy">Energie (Strom, Gas, Öl, Fernwärme)</option>
              <option value="transport">Verkehr</option>
              <option value="finance">Bankwesen / Finanzmarktinfrastruktur</option>
              <option value="health">Gesundheit</option>
              <option value="water">Trinkwasser / Abwasser</option>
              <option value="digital">Digitale Infrastruktur / Cloud / Rechenzentrum</option>
              <option value="public">Öffentliche Verwaltung</option>
              <option value="other">Sonstiger Sektor</option>
            </select>
            <p class="muted">Hinweis: NIS‑2 betrifft bestimmte kritische Sektoren; Auswahl steuert die weiteren Fragen.
            </p>
          </section>

          <!-- Ebene 2 -->
          <section id="q_function" class="space-y-2 hidden" tabindex="-1">
            <label class="font-medium">2) Welche Funktion übt Ihr Unternehmen innerhalb dieses Sektors aus?</label>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
              <label class="p-2 border rounded-md cursor-pointer focus-ring" data-value="operator"><input type="radio"
                  name="function" value="operator" class="mr-2 focus-ring"> Betreiber von Netzen / Versorgungsanlagen</label>
              <label class="p-2 border rounded-md cursor-pointer focus-ring" data-value="supplier"><input type="radio"
                  name="function" value="supplier" class="mr-2 focus-ring"> Energieversorger / Lieferant mit Endkunden</label>
              <label class="p-2 border rounded-md cursor-pointer focus-ring" data-value="metering"><input type="radio"
                  name="function" value="metering" class="mr-2 focus-ring"> Betreiber von Messsystemen / Smart‑Meter</label>
              <label class="p-2 border rounded-md cursor-pointer focus-ring" data-value="platform"><input type="radio"
                  name="function" value="platform" class="mr-2 focus-ring"> Anbieter zentraler
                Marktkommunikationsplattformen</label>
              <label class="p-2 border rounded-md cursor-pointer focus-ring" data-value="service"><input type="radio"
                  name="function" value="service" class="mr-2 focus-ring"> Dienstleister / Subunternehmer (z. B.
                Abrechnung)</label>
            </div>
          </section>

          <!-- Ebene 3 (Dienstleister) -->
          <div id="serviceQuestions" class="space-y-4 hidden" tabindex="-1">
            <section class="space-y-2">
              <label class="font-medium">3.1) Erbringen Sie Dienstleistungen, die für den Betrieb oder die Abrechnung
                kritischer Energieprozesse wesentlich sind?</label>
              <div class="flex gap-2">
                <button type="button" class="btn-yn px-3 py-1 rounded-md border focus-ring" data-target="essential"
                  data-value="yes">Ja</button>
                <button type="button" class="btn-yn px-3 py-1 rounded-md border focus-ring" data-target="essential"
                  data-value="no">Nein</button>
              </div>
            </section>

            <section class="space-y-2">
              <label class="font-medium">3.2) Betreiben oder stellen Sie eigene IT-Systeme bzw. Infrastruktur bereit (z.
                B. Hosting, Plattform, Rechenzentrum, Cloud), über die produktive oder kritische Daten verarbeitet
                werden?</label>
              <div class="flex gap-2">
                <button type="button" class="btn-yn px-3 py-1 rounded-md border focus-ring" data-target="ownSystems"
                  data-value="yes">Ja</button>
                <button type="button" class="btn-yn px-3 py-1 rounded-md border focus-ring" data-target="ownSystems"
                  data-value="no">Nein</button>
              </div>
            </section>

            <section id="managedService" class="space-y-2 hidden">
              <label class="font-medium">3.3) Übernehmen Sie den fachlichen oder technischen Betrieb von IT- oder
                Applikationssystemen Ihrer Kunden (z. B. Konfiguration, Benutzerverwaltung, Release-/Patch-Management,
                Fehleranalyse, Parametrisierung, Incident-Unterstützung), auch wenn die Systeme extern gehostet
                werden?</label>
              <div class="flex gap-2">
                <button type="button" class="btn-yn px-3 py-1 rounded-md border focus-ring" data-target="managedService"
                  data-value="yes">Ja</button>
                <button type="button" class="btn-yn px-3 py-1 rounded-md border focus-ring" data-target="managedService"
                  data-value="no">Nein</button>
              </div>
            </section>

            <section id="multiTenantWrap" class="space-y-2 hidden">
              <label class="font-medium">3.4) Werden diese Systeme von mehreren Energieversorgern/Netzbetreibern genutzt
                (zentrale Rolle)?</label>
              <div class="flex gap-2">
                <button type="button" class="btn-yn px-3 py-1 rounded-md border focus-ring" data-target="multiTenant"
                  data-value="yes">Ja</button>
                <button type="button" class="btn-yn px-3 py-1 rounded-md border focus-ring" data-target="multiTenant"
                  data-value="no">Nein</button>
              </div>
            </section>

            <section id="clientHostedWrap" class="space-y-2 hidden">
              <label class="font-medium">3.5) Werden Ihre Systeme vollständig durch den Auftraggeber betrieben (Sie
                liefern nur Personal / Prozesssupport)?</label>
              <div class="flex gap-2">
                <button type="button" class="btn-yn px-3 py-1 rounded-md border focus-ring" data-target="clientHosted"
                  data-value="yes">Ja</button>
                <button type="button" class="btn-yn px-3 py-1 rounded-md border focus-ring" data-target="clientHosted"
                  data-value="no">Nein</button>
              </div>
            </section>
          </div>

          <!-- Ebene 4 (Größe / Kritikalität) -->
          <section id="sizeSection" class="space-y-2 hidden" tabindex="-1">
            <label class="font-medium">4) Unternehmensgröße / Kritikalität</label>
            <p class="muted">NIS‑2 gilt grundsätzlich für mittlere und große Unternehmen (typisch: &gt;50 Mitarbeitende
              und &gt;10 Mio. € Jahresumsatz), kann aber auch für kleinere Unternehmen gelten, wenn besondere
              Kritikalität vorliegt.</p>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
              <label class="p-2 border rounded-md cursor-pointer focus-ring"><input type="radio" name="size" value="large"
                  class="mr-2 focus-ring"> Mittleres / großes Unternehmen (≥50 MA oder &gt;10M€ Umsatz)</label>
              <label class="p-2 border rounded-md cursor-pointer focus-ring"><input type="radio" name="size" value="small"
                  class="mr-2 focus-ring"> Klein (<50 MA und ≤10M€ Umsatz)</label>
                  <label class="p-2 border rounded-md cursor-pointer focus-ring"><input type="radio" name="size" value="critical"
                      class="mr-2 focus-ring"> Klein, aber betreibt kritische zentrale Systeme</label>
            </div>
          </section>

          <!-- Ebene 5 (Lieferkette) -->
          <section id="supplyChain" class="space-y-2 hidden" tabindex="-1">
            <label class="font-medium">5) Lieferkettenbezug</label>
            <label class="block"><input type="checkbox" id="hasNisClients" class="mr-2 focus-ring"> Ich habe Kunden, die selbst
              NIS‑2-pflichtig sind (z. B. Netzbetreiber, größere Energieversorger)</label>
            <label class="block"><input type="checkbox" id="contractRequirements" class="mr-2 focus-ring"> Verträge verlangen
              IT‑Sicherheitsstandards (ISO27001, BSI‑Grundschutz o.ä.)</label>
            <label class="block"><input type="checkbox" id="processSensitiveData" class="mr-2 focus-ring"> Ich verarbeite
              empfindliche Betriebs- oder Kundendaten meiner Auftraggeber</label>
          </section>

          <div class="pt-4 border-t"></div>

          <div class="flex items-center justify-between">
            <div class="text-sm muted">Antworten werden lokal verarbeitet. Dies ist eine Entscheidungshilfe, keine
              rechtliche Beratung.</div>
            <div class="flex gap-2">
              <button type="button" id="backBtn" class="px-3 py-2 rounded-md border focus-ring">Zurück</button>
              <button type="button" id="evaluateBtn"
                class="px-4 py-2 bg-indigo-600 text-white rounded-lg focus-ring" disabled>Bewertung
                anzeigen</button>
            </div>
          </div>
          <div id="validationMessage" class="hidden text-sm text-red-700" role="status"></div>
        </form>

        <div id="result" class="hidden mt-6" role="region" aria-live="polite" aria-label="NIS-2 Ergebnis">
          <div class="p-4 border rounded-lg bg-indigo-50">
            <h2 id="resultTitle" class="text-lg font-semibold">Ergebnis</h2>
            <p id="resultSummary" class="mt-2" aria-live="polite" aria-atomic="true"></p>
            <div id="resultActions" class="mt-4 flex gap-2">
              <button id="refineBtn" class="px-3 py-2 rounded-md border focus-ring">Fragen anpassen</button>
              <button id="generatePDF" class="px-3 py-2 bg-indigo-600 text-white rounded-md focus-ring">Report als PDF</button>
            </div>
          </div>

          <div id="explain" class="mt-4 space-y-3">
            <details class="p-3 border rounded-md">
              <summary class="font-medium">Details zur Einschätzung</summary>
              <div id="explainText" class="mt-2 muted"></div>
            </details>

            <details class="p-3 border rounded-md">
              <summary class="font-medium">Praxisempfehlungen</summary>
              <ul id="recommendations" class="pl-4 list-disc mt-2 muted"></ul>
            </details>
          </div>
        </div>

      </div>
    </main>

    <footer class="mt-4 text-sm muted">Demo / Prototyp — nicht rechtsverbindlich. Quellen: NIS‑2 Richtlinie,
      BSI‑Hinweise, Best Practices.</footer>
  </div>

  <script>
    // --- Einfacher Entscheidungsbaum-Controller ---
    const startBtn = document.getElementById('startBtn');
    const loadExample = document.getElementById('loadExample');
    const quizForm = document.getElementById('quizForm');
    const intro = document.getElementById('intro');

    const sector = document.getElementById('sector');
    const q_function = document.getElementById('q_function');
    const serviceQuestions = document.getElementById('serviceQuestions');
    const sizeSection = document.getElementById('sizeSection');
    const supplyChain = document.getElementById('supplyChain');

    const backBtn = document.getElementById('backBtn');
    const evaluateBtn = document.getElementById('evaluateBtn');
    const resultDiv = document.getElementById('result');
    const resultTitle = document.getElementById('resultTitle');
    const resultSummary = document.getElementById('resultSummary');
    const explainText = document.getElementById('explainText');
    const recommendations = document.getElementById('recommendations');
    const generatePDF = document.getElementById('generatePDF');
    const downloadReport = document.getElementById('downloadReport');
    const validationMessage = document.getElementById('validationMessage');

    // helper state
    const state = {
      sector: null,
      func: null,
      essential: null,
      ownSystems: null,
      managedService: null,
      multiTenant: null,
      clientHosted: null,
      size: null,
      hasNisClients: false,
      contractRequirements: false,
      processSensitiveData: false,
      result: null
    };

    startBtn.addEventListener('click', () => {
      intro.classList.add('hidden');
      quizForm.classList.remove('hidden');
      q_function.classList.add('hidden');
      document.getElementById('q_sector').scrollIntoView({ behavior: 'smooth' });
      updateEvaluateState();
    });

    loadExample.addEventListener('click', () => {
      // Beispiel: Abrechnungsdienstleister mit eigener Plattform für mehrere Versorger, kleines Unternehmen
      intro.classList.add('hidden');
      quizForm.classList.remove('hidden');
      sector.value = 'energy';
      onSectorChange();
      // set function to service
      document.querySelector('input[name=function][value=service]').checked = true;
      state.func = 'service';
      showServiceQuestions();
      // service answers
      state.essential = true;
      state.ownSystems = true;
      state.managedService = true;
      state.multiTenant = true;
      // size small but critical
      document.querySelector('input[name=size][value=critical]').checked = true;
      state.size = 'critical';
      document.getElementById('hasNisClients').checked = true;
      state.hasNisClients = true;
      document.getElementById('contractRequirements').checked = true;
      state.contractRequirements = true;
      document.getElementById('processSensitiveData').checked = true;
      state.processSensitiveData = true;
      document.getElementById('sizeSection').classList.remove('hidden');
      document.getElementById('supplyChain').classList.remove('hidden');
      refreshYesNoStates();
      updateEvaluateState();
    });

    sector.addEventListener('change', onSectorChange);

    function onSectorChange() {
      const val = sector.value;
      state.sector = val || null;
      if (!val) {
        q_function.classList.add('hidden');
        serviceQuestions.classList.add('hidden');
        sizeSection.classList.add('hidden');
        supplyChain.classList.add('hidden');
        state.func = null;
        refreshYesNoStates();
        updateEvaluateState();
        return;
      }
      q_function.classList.remove('hidden');
      // reset function selection
      document.querySelectorAll('input[name=function]').forEach(i => i.checked = false);
      state.func = null;
      // show/hide further sections depending on selection
      [...document.querySelectorAll('input[name=function]')].forEach(el => el.addEventListener('change', onFunctionChange));
      updateEvaluateState();
    }

    function onFunctionChange(e) {
      const v = e.target.value;
      state.func = v;
      // If service -> show service questions; otherwise show size
      if (v === 'service') {
        showServiceQuestions();
      } else {
        serviceQuestions.classList.add('hidden');
        document.getElementById('sizeSection').classList.remove('hidden');
        document.getElementById('supplyChain').classList.remove('hidden');
      }
      refreshYesNoStates();
      updateEvaluateState();
    }

    function showServiceQuestions() {
      serviceQuestions.classList.remove('hidden');
      document.getElementById('sizeSection').classList.remove('hidden');
      document.getElementById('supplyChain').classList.remove('hidden');

      // attach Y/N buttons
      document.querySelectorAll('.btn-yn').forEach(btn => {
        if (btn.dataset.bound === 'true') return;
        btn.dataset.bound = 'true';
        btn.addEventListener('click', (ev) => {

          const target = ev.currentTarget.dataset.target;
          const val = ev.currentTarget.dataset.value === 'yes';

          // Visual highlight
          const group = document.querySelectorAll(`.btn-yn[data-target="${target}"]`);
          group.forEach(g => g.classList.remove('bg-indigo-600', 'text-white'));
          ev.currentTarget.classList.add('bg-indigo-600', 'text-white');
          group.forEach(g => g.setAttribute('aria-pressed', 'false'));
          ev.currentTarget.setAttribute('aria-pressed', 'true');

          // Update state
          state[target] = val;

          // Speziallogik für ownSystems → entscheidet 3.4 oder 3.5
          if (target === 'ownSystems') {
            if (val) {
              document.getElementById('multiTenantWrap').classList.remove('hidden');
              document.getElementById('clientHostedWrap').classList.add('hidden');
            } else {
              document.getElementById('multiTenantWrap').classList.add('hidden');
              document.getElementById('clientHostedWrap').classList.remove('hidden');
            }
          }

          // multiTenant
          if (target === 'multiTenant') state.multiTenant = val;

          // clientHosted
          if (target === 'clientHosted') state.clientHosted = val;

          // essentielle Dienstleistung
          if (target === 'essential') state.essential = val;

          // MSP / Applikationsbetrieb (NEU!)
          if (target === 'managedService') state.managedService = val;

          refreshYesNoStates();
          updateEvaluateState();
        });
      });
    }


    // size radio
    document.querySelectorAll('input[name=size]').forEach(el => el.addEventListener('change', (e) => {
      state.size = e.target.value;
      updateEvaluateState();
      setValidationMessage('');
    }));

    // supply chain checkboxes
    document.getElementById('hasNisClients').addEventListener('change', e => { state.hasNisClients = e.target.checked; setValidationMessage(''); updateEvaluateState(); });
    document.getElementById('contractRequirements').addEventListener('change', e => { state.contractRequirements = e.target.checked; setValidationMessage(''); updateEvaluateState(); });
    document.getElementById('processSensitiveData').addEventListener('change', e => { state.processSensitiveData = e.target.checked; setValidationMessage(''); updateEvaluateState(); });

    backBtn.addEventListener('click', () => {
      // Einfach: zurück zum intro
      intro.classList.remove('hidden');
      quizForm.classList.add('hidden');
      resultDiv.classList.add('hidden');
      downloadReport.classList.add('hidden');
      setValidationMessage('');
    });

    evaluateBtn.addEventListener('click', evaluate);

    function setValidationMessage(msg) {
      if (!msg) {
        validationMessage.classList.add('hidden');
        validationMessage.textContent = '';
        return;
      }
      validationMessage.classList.remove('hidden');
      validationMessage.textContent = msg;
    }

    function evaluate() {
      syncStateFromForm();
      const firstInvalid = getSteps().find(s => !isStepValid(s.id));
      if (firstInvalid) {
        showInlineValidation(firstInvalid.id);
        return;
      }
      // determine result
      const r = computeResult(state);
      state.result = r;
      showResult(r);
    }

    function showInlineValidation(stepId) {
      let message = 'Bitte beantworte die markierten Pflichtfelder.';
      if (stepId === 'q_sector') message = 'Bitte wähle zuerst einen Sektor.';
      if (stepId === 'q_function') message = 'Bitte wähle die Funktion Deines Unternehmens.';
      if (stepId === 'serviceQuestions') message = 'Bitte beantworte die Dienstleistungsfragen vollständig.';
      if (stepId === 'sizeSection') message = 'Bitte wähle eine Angabe zur Unternehmensgröße.';
      setValidationMessage(message);
      document.getElementById(stepId)?.scrollIntoView({ behavior: 'smooth', block: 'start' });
      updateEvaluateState();
    }

    function getSteps() {
      const base = [
        { id: 'q_sector', label: 'Sektor' },
        { id: 'q_function', label: 'Funktion' }
      ];
      if (state.func === 'service') {
        base.push({ id: 'serviceQuestions', label: 'Dienstleister-Details' });
      }
      base.push({ id: 'sizeSection', label: 'Größe/Kritikalität' });
      base.push({ id: 'supplyChain', label: 'Lieferkette' });
      return base;
    }

    function syncStateFromForm() {
      // defensive sync (falls ein Event einmal nicht feuert)
      state.sector = sector.value || null;
      const selectedFunction = document.querySelector('input[name=function]:checked');
      state.func = selectedFunction ? selectedFunction.value : null;

      const selectedSize = document.querySelector('input[name=size]:checked');
      state.size = selectedSize ? selectedSize.value : null;

      state.hasNisClients = document.getElementById('hasNisClients').checked;
      state.contractRequirements = document.getElementById('contractRequirements').checked;
      state.processSensitiveData = document.getElementById('processSensitiveData').checked;
    }

    function isStepValid(stepId) {
      syncStateFromForm();
      if (stepId === 'q_sector') return !!state.sector;
      if (stepId === 'q_function') return !!state.func;
      if (stepId === 'serviceQuestions') {
        if (state.func !== 'service') return true;
        if (state.essential === null || state.ownSystems === null) return false;
        if (state.ownSystems && state.multiTenant === null) return false;
        if (state.ownSystems === false && state.clientHosted === null) return false;
        return true;
      }
      if (stepId === 'sizeSection') return !!state.size;
      return true;
    }

    function updateEvaluateState() {
      const hasInvalid = getSteps().some(step => !isStepValid(step.id));
      evaluateBtn.disabled = hasInvalid;
    }

    function refreshYesNoStates() {
      const mapping = {
        essential: state.essential,
        ownSystems: state.ownSystems,
        managedService: state.managedService,
        multiTenant: state.multiTenant,
        clientHosted: state.clientHosted
      };

      Object.keys(mapping).forEach(key => {
        const val = mapping[key];
        const buttons = document.querySelectorAll(`.btn-yn[data-target="${key}"]`);
        buttons.forEach(btn => {
          btn.classList.remove('bg-indigo-600', 'text-white');
          btn.setAttribute('aria-pressed', 'false');
          if (val === null) return;
          const isYes = btn.dataset.value === 'yes';
          if ((val && isYes) || (!val && !isYes)) {
            btn.classList.add('bg-indigo-600', 'text-white');
            btn.setAttribute('aria-pressed', 'true');
          }
        });
      });

      if (state.func === 'service') {
        document.getElementById('managedService').classList.remove('hidden');
        if (state.ownSystems === true) {
          document.getElementById('multiTenantWrap').classList.remove('hidden');
          document.getElementById('clientHostedWrap').classList.add('hidden');
        }
        if (state.ownSystems === false) {
          document.getElementById('clientHostedWrap').classList.remove('hidden');
          document.getElementById('multiTenantWrap').classList.add('hidden');
        }
      }
    }

    function computeResult(state) {
      const s = state;
      const critSectors = ['energy', 'water', 'health', 'transport', 'digital', 'ict'];

      const inCriticalSector = critSectors.includes(s.sector);
      const isCriticalSize = (s.size === 'large' || s.size === 'critical');
      const managesCriticalService =
        (s.essential || s.processSensitiveData || s.contractRequirements || s.hasNisClients);

      // Neues MSP-Kriterium
      const isMSP = s.managedService;

      // ---------------------------------------------
      // 1) Betreiber / Infrastruktur
      // ---------------------------------------------
      if (s.func === 'operator') {
        if (inCriticalSector && isCriticalSize) {
          return {
            category: 'A',
            label: 'Direkt betroffen (essentielle Einrichtung – Betreiber)',
            details: 'Sie betreiben kritische Infrastrukturen oder ICT-Systeme eines NIS-2-Kernsektors.'
          };
        }

        if (inCriticalSector && managesCriticalService) {
          return {
            category: 'B',
            label: 'Wahrscheinlich direkt betroffen (wichtige Einrichtung – Betreiber)',
            details: 'Sie verantworten Systeme im kritischen Sektor, deren Ausfall wesentliche Auswirkungen hätte.'
          };
        }

        return {
          category: 'C',
          label: 'Indirekt betroffen',
          details: 'Sie sind Betreiber, jedoch ohne kritische Relevanz nach NIS-2.'
        };
      }

      // ---------------------------------------------
      // 2) Dienstleister / Managed Service Provider
      // ---------------------------------------------
      if (s.func === 'service') {

        // 2.1 Direkt betroffen als MSP oder Plattformanbieter
        if (inCriticalSector && isCriticalSize && (s.ownSystems || isMSP)) {
          return {
            category: 'A',
            label: 'Direkt betroffen (wichtige Einrichtung – Managed Service Provider)',
            details: 'Als MSP/ICT-Dienstleister übernehmen Sie operative Systemverantwortung im kritischen Sektor. ' +
              'NIS-2 betrachtet MSPs explizit als eigene regulierte Einrichtungen.'
          };
        }

        // 2.2 Kritischer MSP ohne große Unternehmensgröße
        if (inCriticalSector && managesCriticalService && isMSP) {
          return {
            category: 'B',
            label: 'Wahrscheinlich direkt betroffen (kritischer MSP – vertiefte Prüfung empfohlen)',
            details: 'Sie übernehmen dauerhaften Applikations- oder Systembetrieb im kritischen Sektor. ' +
              'Die Einstufung als wichtige Einrichtung ist wahrscheinlich.'
          };
        }

        // 2.3 Indirekte Betroffenheit aus Lieferkette
        if (s.clientHosted || s.hasNisClients || s.contractRequirements || s.processSensitiveData) {
          return {
            category: 'C',
            label: 'Indirekt betroffen (Lieferkette / vertragliche Pflichten)',
            details: 'Sie sind Teil der Lieferkette eines NIS-2-pflichtigen Unternehmens, ohne eigene Betriebsverantwortung.'
          };
        }

        return {
          category: 'C',
          label: 'Indirekt betroffen',
          details: 'Keine direkte kritische Rolle nach NIS-2 erkennbar.'
        };
      }

      // ---------------------------------------------
      // 3) Beratung / Sonstige Rollen
      // ---------------------------------------------
      return {
        category: 'C',
        label: 'Indirekt betroffen',
        details: 'Beratende Tätigkeiten fallen nur über vertragliche Anforderungen unter NIS-2.'
      };
    }


    function showResult(r) {

      quizForm.classList.add('hidden');
      resultDiv.classList.remove('hidden');
      setValidationMessage('');

      // Titel
      resultTitle.textContent = r.label;

      // Summary
      let summary = '';
      if (r.category === 'A') summary = 'Ihr Unternehmen ist sehr wahrscheinlich direkt von NIS-2 betroffen. Es fällt unter die Pflichten für essenzielle bzw. wichtige Einrichtungen.';
      if (r.category === 'B') summary = 'Ihr Unternehmen könnte direkt betroffen sein — eine genauere Prüfung der Kritikalität ist notwendig.';
      if (r.category === 'C') summary = 'Ihr Unternehmen ist indirekt betroffen: Als Dienstleister für NIS-2-pflichtige Kunden bestehen vertragliche und technische Sicherheitsanforderungen.';
      if (r.category === 'D') summary = 'Ihr Unternehmen ist nach den erfassten Informationen voraussichtlich nicht von NIS-2 betroffen.';

      resultSummary.innerHTML = summary;

      // -------------------------------------------------
      // MSP-Hinweisblock EINBLENDEN (NEU)
      // -------------------------------------------------
      if (state.managedService) {
        resultSummary.innerHTML += `
      <div class="mt-3 p-3 border-l-4 border-indigo-600 bg-indigo-50 rounded">
        <strong>Hinweis: Managed Service Provider (MSP)</strong><br>
        Sie übernehmen operative Aufgaben im Applikations- oder Systembetrieb Ihrer Kunden.
        Dadurch gelten Sie als eigenständig regulierte Einrichtung unter NIS-2
        (wichtige Einrichtung / MSP) – unabhängig davon, ob Sie selbst hosten.
      </div>`;
      }

      // -------------------------------------------------
      // DETAILDARSTELLUNG
      // -------------------------------------------------
      const expl = [];
      expl.push('Sektor: ' + (state.sector || '—'));
      expl.push('Funktion: ' + (state.func || '—'));

      if (state.func === 'service') {
        expl.push('Erbringt essentielle Dienstleistungen: ' + (state.essential ? 'Ja' : 'Nein'));
        expl.push('Eigene Systeme/Plattformen (Hosting): ' + (state.ownSystems ? 'Ja' : 'Nein'));

        if (state.ownSystems)
          expl.push('Mehrere Kunden (zentral): ' + (state.multiTenant ? 'Ja' : 'Nein'));

        if (!state.ownSystems)
          expl.push('System vollständig durch Kunden betrieben: ' + (state.clientHosted ? 'Ja' : 'Nein'));

        // MSP-Kriterium (NEU)
        expl.push('Applikations- / Systembetrieb (MSP-Rolle): ' + (state.managedService ? 'Ja' : 'Nein'));
      }

      expl.push('Unternehmensgröße/Kritikalität: ' + (state.size || '—'));
      expl.push('Kunden sind NIS-2-pflichtig: ' + (state.hasNisClients ? 'Ja' : 'Nein'));
      expl.push('Vertragliche Sicherheitsanforderungen: ' + (state.contractRequirements ? 'Ja' : 'Nein'));
      expl.push('Verarbeitung sensibler Daten: ' + (state.processSensitiveData ? 'Ja' : 'Nein'));

      explainText.innerHTML = expl.map(x => '<div>' + x + '</div>').join('');

      // -------------------------------------------------
      // EMPFEHLUNGEN
      // -------------------------------------------------
      const recs = [];

      if (r.category === 'A' || r.category === 'B') {
        recs.push('Unmittelbare NIS-2-Konformitätsprüfung durchführen (Risikomanagement, Meldepflichten, Governance).');
        recs.push('ISMS einführen oder nachweisen (z. B. ISO 27001 / BSI-Grundschutz).');
        recs.push('Technische Maßnahmen: Zugriffskontrolle, Patch-Management, Logging, Segmentierung.');

        // Zusätzliche MSP-Empfehlung (NEU)
        if (state.managedService) {
          recs.push('Als MSP besonders wichtig: klare Rollen- und Rechtemodelle, technische Admin-Prozesse, '
            + 'sowie Sicherheitskontrollen gegenüber Ihrem eigenen IT-Dienstleister (Lieferkette).');
        }
      }

      if (r.category === 'C') {
        recs.push('Vertragliche Anforderungen Ihrer Kunden prüfen und erfüllen (SLAs, Auditrechte).');
        recs.push('Basis-ISMS und Nachweismaßnahmen implementieren (Zugriffsrollen, Verschlüsselung, Backup).');
        recs.push('Sicherheitsnachweise gegenüber Kunden bereitstellen (z. B. Audit-Reports).');
      }

      if (r.category === 'D') {
        recs.push('Grundlegende Cyber-Hygiene sicherstellen (Passwortmanagement, Updates, Backups).');
        recs.push('Bei Geschäften mit NIS-2-relevanten Kunden vorbereitende Maßnahmen einplanen.');
      }

      recommendations.innerHTML = recs.map(x => '<li>' + x + '</li>').join('');

      downloadReport.classList.remove('hidden');
    }

    // generate simple PDF via window.print (prints page) — minimal approach for demo
    generatePDF.addEventListener('click', () => {
      window.print();
    });

    // download JSON report
    downloadReport.addEventListener('click', () => {
      const report = {
        timestamp: new Date().toISOString(),
        state, result: state.result
      };
      const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'nis2_report_' + new Date().toISOString().slice(0, 19).replace(/[:T]/g, '_') + '.json';
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    // refine
    document.getElementById('refineBtn').addEventListener('click', () => {
      resultDiv.classList.add('hidden');
      quizForm.classList.remove('hidden');
      setValidationMessage('');
      refreshYesNoStates();
      updateEvaluateState();
      document.getElementById('q_sector').scrollIntoView({ behavior: 'smooth' });
    });

    // small accessibility: allow Enter to start when focused on startBtn
    startBtn.addEventListener('keyup', (e) => { if (e.key === 'Enter') startBtn.click(); });

    // initial button state
    updateEvaluateState();

  </script>
</body>

</html>